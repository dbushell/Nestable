/*!
 * Nestable jQuery Plugin - Copyright (c) 2012 David Bushell - http://dbushell.com/
 * Dual-licensed under the BSD or MIT licenses
 */
;(function(f,c,a,h){var e="ontouchstart" in c;var d=(function(){var j=a.createElement("div"),k=a.documentElement;if(!("pointerEvents" in j.style)){return false}j.style.pointerEvents="auto";j.style.pointerEvents="x";k.appendChild(j);var i=c.getComputedStyle&&c.getComputedStyle(j,"").pointerEvents==="auto";k.removeChild(j);return !!i})();var g={actionClass:"dd-action",listNodeName:"ol",itemNodeName:"li",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",noNestClass:"dd-nonest",emptyClass:"dd-empty",customActions:{},expandBtnHTML:'<button class="dd-action" data-action="expand" type="button" title="Expand">+</button>',collapseBtnHTML:'<button class="dd-action" data-action="collapse" type="button" title="Collapse">-</button>',group:0,maxDepth:5,threshold:20,isNestAllowed:function(i,j){return true}};function b(j,i){this.w=f(c);this.el=f(j);this.options=f.extend({},g,i);this.init()}b.prototype={init:function(){var l=this;l.reset();l.el.data("nestable-group",this.options.group);l.placeEl=f('<div class="'+l.options.placeClass+'"/>');f.each(this.el.find(l.options.itemNodeName),function(m,n){l.setParent(f(n))});l.el.on("click","."+l.options.actionClass,function(p){if(l.dragEl||(!e&&p.button!==0)){return}var o=f(p.currentTarget),n=o.data("action"),m=o.parent(l.options.itemNodeName);if(n==="collapse"){l.collapseItem(m)}else{if(n==="expand"){l.expandItem(m)}else{if(typeof l.options.customActions!="undefined"&&l.options.customActions.hasOwnProperty(n)){l.options.customActions[n](m,o,p)}}}});var i=function(o){var m=o.type!="mousedown";var n=f(o.target);if(!n.hasClass(l.options.handleClass)){if(n.closest("."+l.options.noDragClass).length){return}n=n.closest("."+l.options.handleClass)}if(!n.length||l.dragEl||(!m&&o.button!==0)||(m&&o.touches.length!==1)){return}o.preventDefault();l.dragStart(m?o.touches[0]:o)};var k=function(n){var m=n.type!="mousemove";if(l.dragEl){n.preventDefault();l.dragMove(m?n.touches[0]:n)}};var j=function(n){var m=n.type!="mouseup";if(l.dragEl){n.preventDefault();l.dragStop(m?n.touches[0]:n)}};if(e){l.el[0].addEventListener("touchstart",i,false);c.addEventListener("touchmove",k,false);c.addEventListener("touchend",j,false);c.addEventListener("touchcancel",j,false)}l.el.on("mousedown",i);l.w.on("mousemove",k);l.w.on("mouseup",j)},serialize:function(){var k,l=0,j=this,i=function(p,n){var o=[],m=p.children(j.options.itemNodeName);m.each(function(){var q=f(this),s=f.extend({},q.data()),r=q.children(j.options.listNodeName);if(r.length){s.children=i(r,n+1)}o.push(s)});return o};k=i(j.el.find(j.options.listNodeName).first(),l);return k},serialise:function(){return this.serialize()},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0};this.moving=false;this.dragEl=null;this.dragRootEl=null;this.dragDepth=0;this.hasNewRoot=false;this.pointEl=null},expandItem:function(i){i.removeClass(this.options.collapsedClass);i.children('[data-action="expand"]').hide();i.children('[data-action="collapse"]').show();i.children(this.options.listNodeName).show()},collapseItem:function(j){var i=j.children(this.options.listNodeName);if(i.length){j.addClass(this.options.collapsedClass);j.children('[data-action="collapse"]').hide();j.children('[data-action="expand"]').show();j.children(this.options.listNodeName).hide()}},expandAll:function(){var i=this;i.el.find(i.options.itemNodeName).each(function(){i.expandItem(f(this))})},collapseAll:function(){var i=this;i.el.find(i.options.itemNodeName).each(function(){i.collapseItem(f(this))})},setParent:function(i){if(i.children(this.options.listNodeName).length){i.prepend(f(this.options.expandBtnHTML));i.prepend(f(this.options.collapseBtnHTML))}i.children('[data-action="expand"]').hide()},unsetParent:function(i){i.removeClass(this.options.collapsedClass);i.children('[data-action="expand"]').remove();i.children('[data-action="collapse"]').remove();i.children(this.options.listNodeName).remove()},dragStart:function(o){var k=this.mouse,n=f(o.target),m=n.closest(this.options.itemNodeName);this.placeEl.css("height",m.height());k.offsetX=o.offsetX!==h?o.offsetX:o.pageX-n.offset().left;k.offsetY=o.offsetY!==h?o.offsetY:o.pageY-n.offset().top;k.startX=k.lastX=o.pageX;k.startY=k.lastY=o.pageY;this.dragRootEl=this.el;this.dragEl=f(a.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass);this.dragEl.css("width",m.width());m.after(this.placeEl);m[0].parentNode.removeChild(m[0]);m.appendTo(this.dragEl);f(a.body).append(this.dragEl);this.dragEl.css({left:o.pageX-k.offsetX,top:o.pageY-k.offsetY});var l,p,j=this.dragEl.find(this.options.itemNodeName);for(l=0;l<j.length;l++){p=f(j[l]).parents(this.options.listNodeName).length;if(p>this.dragDepth){this.dragDepth=p}}},dragStop:function(j){var i=this.dragEl.children(this.options.itemNodeName).first();i[0].parentNode.removeChild(i[0]);this.placeEl.replaceWith(i);this.dragEl.remove();this.el.trigger("change");if(this.hasNewRoot){this.dragRootEl.trigger("change")}this.reset()},canDrop:function(j,i){var k=this.placeEl.parents(i.listNodeName).length;return !j.hasClass(i.noNestClass)&&k+this.dragDepth<=i.maxDepth&&i.isNestAllowed(j,this.dragEl.children(i.itemNodeName).first())},addToList:function(k,i){var j=k.find(i.listNodeName).last();if(!j.length){j=f("<"+i.listNodeName+"/>").addClass(i.listClass);j.append(this.placeEl);k.append(j);this.setParent(k)}else{j=k.children(i.listNodeName).last();j.append(this.placeEl)}},dragMove:function(p){var q,u,n,m,j=this.options,r=this.mouse,k=this.placeEl.prev(j.itemNodeName);this.dragEl.css({left:p.pageX-r.offsetX,top:p.pageY-r.offsetY});r.lastX=r.nowX;r.lastY=r.nowY;r.nowX=p.pageX;r.nowY=p.pageY;r.distX=r.nowX-r.lastX;r.distY=r.nowY-r.lastY;r.lastDirX=r.dirX;r.lastDirY=r.dirY;r.dirX=r.distX===0?0:r.distX>0?1:-1;r.dirY=r.distY===0?0:r.distY>0?1:-1;var i=Math.abs(r.distX)>Math.abs(r.distY)?1:0;if(!r.moving){r.dirAx=i;r.moving=true;return}if(r.dirAx!==i){r.distAxX=0;r.distAxY=0}else{r.distAxX+=Math.abs(r.distX);if(r.dirX!==0&&r.dirX!==r.lastDirX){r.distAxX=0}r.distAxY+=Math.abs(r.distY);if(r.dirY!==0&&r.dirY!==r.lastDirY){r.distAxY=0}}r.dirAx=i;if(r.dirAx&&r.distAxX>=j.threshold){r.distAxX=0;if(r.distX>0&&k.length&&!k.hasClass(j.collapsedClass)){if(this.canDrop(k,j)){this.addToList(k,j)}}}var l=false;if(!d){this.dragEl[0].style.visibility="hidden"}this.pointEl=f(a.elementFromPoint(p.pageX-a.body.scrollLeft,p.pageY-(c.pageYOffset||a.documentElement.scrollTop)));if(!d){this.dragEl[0].style.visibility="visible"}if(this.pointEl.hasClass(j.handleClass)){this.pointEl=this.pointEl.parent(j.itemNodeName)}if(this.pointEl.hasClass(j.emptyClass)){l=true}else{if(!this.pointEl.length||!this.pointEl.hasClass(j.itemClass)){return}}var o=this.pointEl.closest("."+j.rootClass),t=this.dragRootEl.data("nestable-id")!==o.data("nestable-id");if(!r.dirAx||t||l){if(t&&j.group!==o.data("nestable-group")){return}m=this.dragDepth-1+this.pointEl.parents(j.listNodeName).length;if(m>j.maxDepth){return}var s=p.pageY<(this.pointEl.offset().top+this.pointEl.height()/2),v=this.pointEl.parents(j.itemNodeName).first();u=this.placeEl.parent();if(l){q=f(a.createElement(j.listNodeName)).addClass(j.listClass);q.append(this.placeEl);this.pointEl.replaceWith(q)}else{if(s&&this.canDrop(v,j)){this.pointEl.before(this.placeEl)}else{if(this.canDrop(v,j)){this.pointEl.after(this.placeEl)}else{if(this.canDrop(this.pointEl,j)){this.addToList(this.pointEl,j)}}}}if(!u.children().length){this.unsetParent(u.parent())}if(!this.dragRootEl.find(j.itemNodeName).length){this.dragRootEl.append('<div class="'+j.emptyClass+'"/>')}if(t){this.dragRootEl=o;this.hasNewRoot=this.el[0]!==this.dragRootEl[0]}}}};f.fn.nestable=function(k){var i=this,j=this;i.each(function(){var l=f(this).data("nestable");if(!l){f(this).data("nestable",new b(this,k));f(this).data("nestable-id",new Date().getTime())}else{if(typeof k==="string"&&typeof l[k]==="function"){j=l[k]()}}});return j||i}})(window.jQuery||window.Zepto,window,document);